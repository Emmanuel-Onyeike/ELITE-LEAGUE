<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    try {
      const firebaseConfig = {
        apiKey: "AIzaSyALpkq15pxX-0M0SV7-p417EeanTeMpUNI",
        authDomain: "eliteleague-92cce.firebaseapp.com",
        databaseURL: "https://eliteleague-92cce-default-rtdb.firebaseio.com",
        projectId: "eliteleague-92cce",
        storageBucket: "eliteleague-92cce.firebasestorage.app",
        messagingSenderId: "1050191750222",
        appId: "1:1050191750222:web:c9dd71c24c063b685ecf1f",
        measurementId: "G-K9S69VNN7H"
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      window.db = firebase.database();

      // Capture the ORIGINAL verify function (for broadcasts PIN 3478)
      const originalVerifyEliteAccess = window.verifyEliteAccess || function() {};

      // === 1. LIVE PACKETS (Existing News System) ===
      window.eliteLivePackets = [];
      const packetsRef = window.db.ref('livePackets').orderByChild('timestamp').limitToLast(50);
      packetsRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
          window.eliteLivePackets = Object.keys(data)
            .map(key => ({ id: key, ...data[key] }))
            .reverse();
        } else {
          window.eliteLivePackets = [];
        }
        if (document.getElementById('viewTitle')?.innerText.includes('News')) {
          if (typeof renderLiveInjection === 'function') renderLiveInjection();
        }
      });

      // === 2. LIVE MATCHES (Football Live Scores) ===
      window.eliteLiveMatches = [];
      const matchesRef = window.db.ref('liveMatches');
      matchesRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
          window.eliteLiveMatches = Object.keys(data)
            .map(key => ({ id: key, ...data[key] }))
            .sort((a, b) => {
              const order = { live: 0, ht: 1, interrupted: 2, not_started: 3, ft: 4 };
              return (order[a.status || 'not_started'] || 5) - (order[b.status || 'not_started'] || 5);
            });
        } else {
          window.eliteLiveMatches = [];
        }
        // Re-render whenever data changes AND we're on Live page
        if (document.getElementById('viewTitle')?.innerText.includes('Live')) {
          if (typeof renderLiveMatches === 'function') renderLiveMatches();
        }
      });

      console.log('Supreme Controller Online – Live Matches + Broadcasts Active');
    } catch (e) {
      console.warn('Firebase init failed:', e);
      window.eliteLivePackets = [];
      window.eliteLiveMatches = [];
    }
  });

  // === RENDER LIVE MATCHES ===
  function renderLiveMatches() {
    const zone = document.getElementById('liveMatchesZone');
    const notice = document.getElementById('noMatchesNotice');
    if (!zone || !notice) return;

    const matches = window.eliteLiveMatches || [];

    if (matches.length === 0) {
      notice.style.display = 'block';
      zone.innerHTML = '';
      return;
    }

    notice.style.display = 'none';

    const matchesHTML = matches.map(match => {
      const dotClass =
        match.dotColor === 'red' ? 'bg-red-500 animate-ping' :
        match.dotColor === 'black' ? 'bg-black' :
        match.dotColor === 'orange' ? 'bg-orange-500' :
        'bg-gray-500';

      const statusText =
        (match.status || 'not_started') === 'not_started' ? 'NOT STARTED YET' :
        match.status === 'live' ? 'LIVE' :
        match.status === 'ht' ? 'HT' :
        match.status === 'ft' ? 'FULL TIME' :
        match.status === 'interrupted' ? 'INTERRUPTED' : 'NOT STARTED';

      const statusColor =
        match.status === 'live' ? 'text-red-500' :
        match.status === 'ht' ? 'text-yellow-500' :
        match.status === 'interrupted' ? 'text-orange-500' :
        match.status === 'ft' ? 'text-gray-400' : 'text-gray-500';

      return `
      <div class="bg-white/5 border border-white/10 rounded-[2.5rem] p-10 hover:border-red-500/30 transition-all group shadow-2xl">
        <div class="flex items-center justify-between">
          <div class="flex-1 grid grid-cols-3 items-center text-center gap-8">
            <div>
              <p class="text-white font-black text-2xl uppercase tracking-tight">${match.homeTeam || 'HOME'}</p>
              <span onclick="editScore('${match.id}', 'home')" 
                    class="cursor-pointer text-7xl font-black text-white hover:text-red-400 transition-all block mt-4">
                ${match.homeScore || 0}
              </span>
            </div>
            <div class="text-5xl font-black text-gray-600">-</div>
            <div>
              <p class="text-white font-black text-2xl uppercase tracking-tight">${match.awayTeam || 'AWAY'}</p>
              <span onclick="editScore('${match.id}', 'away')" 
                    class="cursor-pointer text-7xl font-black text-white hover:text-red-400 transition-all block mt-4">
                ${match.awayScore || 0}
              </span>
            </div>
          </div>
          <div class="ml-12 flex flex-col items-center gap-6">
            <div class="w-6 h-6 rounded-full ${dotClass} shadow-2xl"></div>
            <span onclick="controlMatchStatus('${match.id}', '${match.status || 'not_started'}')"
                  class="cursor-pointer text-[12px] font-black uppercase tracking-widest ${statusColor} hover:underline">
              ${statusText}
            </span>
          </div>
        </div>
        ${match.lastUpdated ? 
          `<p class="text-[9px] text-gray-600 text-center mt-8 uppercase tracking-widest opacity-60">
             LAST UPDATE: ${match.lastUpdated}
           </p>` : ''}
      </div>`;
    }).join('');

    zone.innerHTML = matchesHTML;
  }

  // === LIVE MATCH CONTROL ===
  let currentMatchId = null;
  let currentAction = null;
  let currentMatchStatus = null;

  function editScore(matchId, side) {
    currentMatchId = matchId;
    currentAction = 'score_' + side;
    openAdminModal();
  }

  function controlMatchStatus(matchId, status) {
    currentMatchId = matchId;
    currentAction = 'status';
    currentMatchStatus = status;
    openAdminModal();
  }

  // TEMPORARILY OVERRIDE verifyEliteAccess for Live Scores (PIN 2000)
  window.verifyEliteAccess = function() {
    const pinField = document.getElementById('adminPin');
    if (!pinField) return;

    if (pinField.value === '2000') {
      document.getElementById('adminModal').style.display = 'none';
      pinField.value = '';

      const now = new Date().toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }).toUpperCase() +
                  ' - ' +
                  new Date().toTimeString().slice(0, 5) + ' UTC';

      if (currentAction?.startsWith('score')) {
        const side = currentAction === 'score_home' ? 'HOME' : 'AWAY';
        const newScore = prompt(`NEW SCORE FOR ${side} TEAM:`);
        if (newScore === null) return;
        const score = parseInt(newScore);
        if (isNaN(score) || score < 0) {
          alert('INVALID SCORE');
          return;
        }
        window.db.ref(`liveMatches/${currentMatchId}`).update({
          [`${currentAction.split('_')[1]}Score`]: score,
          lastUpdated: now
        });
      }

      else if (currentAction === 'status') {
        let promptText = "ELITE CONTROL PANEL\n\n";
        if (currentMatchStatus === 'not_started') {
          promptText += "1 → START MATCH (GO LIVE)\n";
        } else if (currentMatchStatus === 'live') {
          promptText += "1 → HALF TIME (HT)\n2 → INTERRUPTED\n3 → FULL TIME (FT)\n";
        } else if (currentMatchStatus === 'ht') {
          promptText += "1 → RESUME MATCH (2ND HALF - LIVE)\n2 → FULL TIME (FT)\n";
        } else {
          promptText += "1 → RESUME / RESTART\n";
        }

        const choice = prompt(promptText, "1");
        if (!choice) return;

        let updates = { lastUpdated: now };

        if ((currentMatchStatus === 'not_started' && choice === '1') ||
            (currentMatchStatus === 'ht' && choice === '1')) {
          updates.status = 'live';
          updates.dotColor = 'red';
        } else if (currentMatchStatus === 'live' && choice === '1') {
          updates.status = 'ht';
          updates.dotColor = 'black';
        } else if (currentMatchStatus === 'live' && choice === '2') {
          updates.status = 'interrupted';
          updates.dotColor = 'orange';
        } else if ((currentMatchStatus === 'live' && choice === '3') ||
                   (currentMatchStatus === 'ht' && choice === '2')) {
          updates.status = 'ft';
          updates.dotColor = 'grey';
        }

        window.db.ref(`liveMatches/${currentMatchId}`).update(updates);
      }
    } else {
      alert("ACCESS DENIED: INVALID PIN");
      pinField.value = '';
    }

    // Reset control variables
    currentAction = null;
    currentMatchId = null;
    currentMatchStatus = null;
  };

  // Restore original verifyEliteAccess when modal is closed (click outside)
  document.getElementById('adminModal')?.addEventListener('click', (e) => {
    if (e.target.id === 'adminModal') {
      const original = window.originalVerifyEliteAccess || function() {};
      window.verifyEliteAccess = original;
    }
  });

  // Store original for safety
  window.originalVerifyEliteAccess = window.verifyEliteAccess;
</script>
