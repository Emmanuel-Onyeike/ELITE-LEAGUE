<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UPLINK | Mobile Secure Terminal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&display=swap');
        
        /* Lock the body to prevent any scrolling/shaking */
        html, body { 
            height: 100%; 
            width: 100%; 
            overflow: hidden; 
            position: fixed; 
            background-color: #020617;
            color: #e2e8f0;
            font-family: 'Space Grotesk', sans-serif;
            touch-action: manipulation;
        }

        .glass { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px); }
        .cyber-border { border-color: rgba(59, 130, 246, 0.2); }
        
        /* Prevent browser bounce/overscroll */
        main {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-y: contain;
        }

        .drawer-hide { transform: translateY(100%); transition: transform 0.3s ease-out; }
        
        /* Voice Button Stability */
        #voice-btn {
            touch-action: none; /* Crucial: stops the screen from shaking/scrolling while holding */
            -webkit-user-select: none;
            user-select: none;
        }

        .recording-active { 
            color: #ef4444 !important; 
            filter: drop-shadow(0 0 10px #ef4444);
        }

        /* Mobile Audio Player Fix */
        audio { height: 35px; width: 100%; max-width: 200px; filter: invert(1); }
    </style>
</head>
<body class="flex flex-col">

    <div id="username-modal" class="fixed inset-0 z-[100] flex items-center justify-center bg-[#020617]">
        <div class="p-6 w-full max-w-sm text-center">
            <h1 class="text-xl font-bold tracking-[0.3em] mb-6 text-blue-500 uppercase">Secure Link</h1>
            <input type="text" id="username-input" maxlength="12"
                class="w-full bg-slate-900 border border-blue-900 focus:border-blue-500 rounded-lg py-3 text-center text-lg outline-none text-blue-400 font-mono"
                placeholder="CALLSIGN...">
            <button onclick="establishLink()" class="mt-6 w-full py-4 bg-blue-600 active:bg-blue-400 text-white font-bold uppercase rounded-lg transition-colors">
                Initialize
            </button>
        </div>
    </div>

    <div id="alert-modal" class="hidden fixed inset-0 z-[110] flex items-center justify-center bg-black/80 p-4">
        <div class="bg-slate-900 border border-red-500/40 p-6 rounded-xl w-full max-w-[280px] text-center shadow-2xl">
            <p id="alert-text" class="text-white font-mono text-xs mb-6 uppercase leading-relaxed"></p>
            <button onclick="closeAlert()" class="w-full py-3 bg-red-500/20 text-red-500 text-[10px] font-bold uppercase rounded-md">Acknowledge</button>
        </div>
    </div>

    <header class="h-14 flex-none border-b cyber-border flex items-center justify-between px-4 glass z-50">
        <div class="flex items-center gap-2">
            <div class="w-2 h-2 bg-green-500 rounded-full"></div>
            <span class="font-bold text-[10px] tracking-widest uppercase">Node: Active</span>
        </div>
        <div id="user-tag" class="text-[9px] font-mono text-slate-500 uppercase"></div>
    </header>

    <main id="chat-display" class="flex-1 p-4 space-y-4 pt-4 pb-24">
        <div class="text-center py-6 opacity-10 text-[8px] uppercase tracking-[0.8em]">End-to-End Encrypted</div>
    </main>

    <div id="asset-drawer" class="fixed bottom-[70px] left-0 right-0 glass border-t cyber-border drawer-hide z-40 h-48 p-4">
        <div id="sticker-grid" class="flex flex-wrap gap-4 overflow-x-auto pb-2">
            <img onclick="sendSticker(this.src)" src="https://cdn-icons-png.flaticon.com/512/3062/3062125.png" class="w-12 h-12 active:scale-90">
            <img onclick="sendSticker(this.src)" src="https://cdn-icons-png.flaticon.com/512/3062/3062128.png" class="w-12 h-12 active:scale-90">
        </div>
        <div class="flex gap-6 text-3xl mt-4 border-t border-slate-800 pt-4">
            <span onclick="addEmoji('üî•')" class="active:scale-125">üî•</span>
            <span onclick="addEmoji('üõ°Ô∏è')" class="active:scale-125">üõ°Ô∏è</span>
            <span onclick="addEmoji('‚ö†Ô∏è')" class="active:scale-125">‚ö†Ô∏è</span>
        </div>
    </div>

    <footer class="h-[70px] flex-none glass border-t cyber-border px-2 py-3 z-50">
        <div class="flex items-center gap-1 h-full">
            <label class="p-2 text-slate-400 active:text-blue-400">
                <i class="fas fa-plus"></i>
                <input type="file" id="image-input" class="hidden" accept="image/*">
            </label>

            <button onclick="toggleDrawer()" class="p-2 text-slate-400 active:text-blue-400">
                <i class="fas fa-face-smile"></i>
            </button>

            <div class="flex-1 relative h-10">
                <input type="text" id="msg-input" placeholder="Secure..." 
                    class="w-full h-full bg-slate-950/50 border border-slate-800 rounded-full px-4 py-1 text-sm outline-none focus:border-blue-500/40">
                <div id="recording-status" class="hidden absolute inset-0 bg-blue-900 rounded-full flex items-center px-4 text-[9px] font-bold text-red-400 uppercase">
                    <span class="animate-pulse">‚óè Recording...</span>
                </div>
            </div>

            <button id="voice-btn" class="p-3 text-slate-400">
                <i class="fas fa-microphone"></i>
            </button>

            <button onclick="sendMessage()" class="bg-blue-600 w-10 h-10 rounded-full text-white active:bg-blue-400 flex items-center justify-center">
                <i class="fas fa-paper-plane text-xs"></i>
            </button>
        </div>
    </footer>

    <script>
        let userName = "";
        let mediaRecorder;
        let audioChunks = [];
        const chatDisplay = document.getElementById('chat-display');
        const voiceBtn = document.getElementById('voice-btn');
        const recordingStatus = document.getElementById('recording-status');

        function showAlert(msg) {
            document.getElementById('alert-text').innerText = msg;
            document.getElementById('alert-modal').classList.remove('hidden');
        }
        function closeAlert() { document.getElementById('alert-modal').classList.add('hidden'); }

        function establishLink() {
            const input = document.getElementById('username-input');
            if(input.value.length < 2) {
                showAlert("Identity Rejected: Call-sign too short");
                return;
            }
            userName = input.value.toUpperCase();
            document.getElementById('username-modal').style.display = 'none';
            document.getElementById('user-tag').innerText = userName;
            appendMessage("SYSTEM", `Encrypted session for ${userName}`, 'system');
            initVoice();
        }

        function appendMessage(user, content, type = 'text') {
            const isMe = user === userName;
            const div = document.createElement('div');
            div.className = `flex flex-col ${type === 'system' ? 'items-center' : (isMe ? 'items-end' : 'items-start')} w-full px-2`;
            
            let html = "";
            if(type === 'text') {
                html = `<div class="${isMe ? 'bg-blue-600' : 'bg-slate-800'} px-4 py-2 rounded-2xl max-w-[85%] text-sm shadow-md">${content}</div>`;
            } else if(type === 'voice') {
                html = `<div class="bg-slate-800 p-2 rounded-xl border border-blue-900/50"><audio controls src="${content}"></audio></div>`;
            } else if(type === 'image') {
                html = `<img src="${content}" class="rounded-lg max-w-[70%] border cyber-border" onclick="saveSticker(this.src)">`;
            } else if(type === 'sticker') {
                html = `<img src="${content}" class="w-20 h-20">`;
            } else if(type === 'system') {
                html = `<div class="text-[8px] text-blue-500/50 uppercase tracking-widest py-2">${content}</div>`;
            }

            div.innerHTML = `${type !== 'system' ? `<span class="text-[8px] text-slate-500 mb-1 px-1 uppercase">${user}</span>` : ''}${html}`;
            chatDisplay.appendChild(div);
            chatDisplay.scrollTop = chatDisplay.scrollHeight;
        }

        // --- STABLE VOICE RECORDING ---
        async function initVoice() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const blob = new Blob(audioChunks, { type: 'audio/webm' });
                    appendMessage(userName, URL.createObjectURL(blob), 'voice');
                    audioChunks = [];
                };
            } catch (err) { console.log("Mic access denied"); }
        }

        const startRec = (e) => {
            e.preventDefault(); 
            if(!mediaRecorder) return;
            audioChunks = [];
            mediaRecorder.start();
            voiceBtn.classList.add('recording-active');
            recordingStatus.classList.remove('hidden');
        };

        const stopRec = (e) => {
            e.preventDefault();
            if(mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop();
                voiceBtn.classList.remove('recording-active');
                recordingStatus.classList.add('hidden');
            }
        };

        // Touch events for mobile, Mouse for desktop
        voiceBtn.addEventListener('touchstart', startRec, {passive: false});
        voiceBtn.addEventListener('touchend', stopRec, {passive: false});
        voiceBtn.addEventListener('mousedown', startRec);
        window.addEventListener('mouseup', stopRec);

        function sendMessage() {
            const input = document.getElementById('msg-input');
            if(!input.value.trim()) return;
            appendMessage(userName, input.value);
            input.value = "";
            document.getElementById('asset-drawer').classList.add('drawer-hide');
        }

        function toggleDrawer() { document.getElementById('asset-drawer').classList.toggle('drawer-hide'); }
        function addEmoji(emoji) { document.getElementById('msg-input').value += emoji; }
        function sendSticker(src) { appendMessage(userName, src, 'sticker'); toggleDrawer(); }

        document.getElementById('image-input').onchange = (e) => {
            const reader = new FileReader();
            reader.onload = (f) => appendMessage(userName, f.target.result, 'image');
            reader.readAsDataURL(e.target.files[0]);
        };

        document.getElementById('msg-input').onkeypress = (e) => { if(e.key === 'Enter') sendMessage(); };
    </script>
</body>
</html>
