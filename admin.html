<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard - Elite League</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Inter', sans-serif; background: #0f172a; }
    .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
    .sidebar-link.active { background: #3b82f6; color: white; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
  </style>

  <script>
    // === SUPABASE CONFIG ===
    const supabaseUrl = 'https://your-project.supabase.co'; 
    const supabaseAnonKey = 'your-anon-key-here'; 
    const { createClient } = supabase;
    const supabaseClient = createClient(supabaseUrl, supabaseAnonKey);

    const ADMIN_PASSWORD = "elite2026";
    let eliteLeagueId = null;
    let currentMatchId = null;

    // === CUSTOM MODAL SYSTEM ===
    function showAlert(title, message, callback = null) {
        const modal = document.getElementById('customModal');
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalMessage').innerText = message;
        document.getElementById('modalPromptInput').classList.add('hidden');
        document.getElementById('modalConfirmBtn').onclick = () => {
            modal.classList.add('hidden');
            if(callback) callback();
        };
        modal.classList.remove('hidden');
    }

    function showPrompt(title, message, callback) {
        const modal = document.getElementById('customModal');
        const input = document.getElementById('modalPromptInput');
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalMessage').innerText = message;
        input.classList.remove('hidden');
        input.value = "";
        document.getElementById('modalConfirmBtn').onclick = () => {
            modal.classList.add('hidden');
            callback(input.value);
        };
        modal.classList.remove('hidden');
    }

    // === TAB SYSTEM ===
    function showSection(sectionId) {
        document.querySelectorAll('.admin-section').forEach(s => s.classList.add('hidden'));
        document.getElementById(sectionId).classList.remove('hidden');
        document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }

    // === AUTH ===
    async function checkPassword() {
      showPrompt("Security Check", "Please enter the admin access code:", (pass) => {
          if (pass !== ADMIN_PASSWORD) {
              window.location.href = "index.html";
          }
      });
    }

    // === DATA LOGIC (Modified to use Custom Modals) ===
    async function ensureEliteLeagueExists() {
      let { data, error } = await supabaseClient.from('leagues').select('id').eq('name', 'Elite League').single();
      if (error && error.code !== 'PGRST116') return null;
      if (data) return data.id;
      const { data: newLeague } = await supabaseClient.from('leagues').insert({ name: 'Elite League' }).select().single();
      return newLeague.id;
    }

    async function loadTeams() {
      if (!eliteLeagueId) return;
      const { data: teams } = await supabaseClient.from('teams').select('*').eq('league_id', eliteLeagueId).order('name');
      
      const home = document.getElementById('homeTeam');
      const away = document.getElementById('awayTeam');
      home.innerHTML = away.innerHTML = '<option value="">Select Team</option>';
      
      const list = document.getElementById('teamsList');
      list.innerHTML = '';
      
      teams.forEach(team => {
        const opt = `<option value="${team.id}">${team.name}</option>`;
        home.innerHTML += opt; away.innerHTML += opt;
        list.innerHTML += `<div class="glass p-4 rounded-xl flex items-center justify-between border-l-4 border-blue-500">
          <span class="font-semibold text-blue-100">${team.name}</span>
          <span class="text-xs text-gray-400 uppercase tracking-widest">Active</span>
        </div>`;
      });
    }

    async function createTeam() {
      const name = document.getElementById('teamName').value.trim();
      if (!name) return showAlert("Error", "Team name cannot be empty.");
      const { error } = await supabaseClient.from('teams').insert({ league_id: eliteLeagueId, name: name });
      if (error) showAlert("Database Error", error.message);
      else {
        showAlert("Success", `${name} added to the league.`);
        document.getElementById('teamName').value = '';
        loadTeams();
      }
    }

    async function createMatch() {
      const homeId = document.getElementById('homeTeam').value;
      const awayId = document.getElementById('awayTeam').value;
      const date = document.getElementById('matchDate').value;
      if (!homeId || !awayId || !date) return showAlert("Incomplete", "Please select teams and set a date.");

      const { error } = await supabaseClient.from('matches').insert({
        league_id: eliteLeagueId, home_team_id: homeId, away_team_id: awayId,
        date: date, status: 'scheduled', home_score: 0, away_score: 0
      });

      if (error) showAlert("Error", error.message);
      else {
        showAlert("Scheduled", "New match successfully created.");
        loadUpcomingMatches();
      }
    }

    async function loadUpcomingMatches() {
      const { data } = await supabaseClient.from('matches').select('*, home:teams!home_team_id(name), away:teams!away_team_id(name)')
        .eq('league_id', eliteLeagueId).in('status', ['scheduled']).order('date');

      const container = document.getElementById('upcomingMatches');
      container.innerHTML = (data.length === 0) ? '<p class="text-gray-500 py-4">No scheduled fixtures.</p>' : '';
      
      data.forEach(match => {
        const d = new Date(match.date);
        container.innerHTML += `
          <div class="glass p-6 rounded-2xl flex flex-col md:flex-row items-center justify-between gap-4 mb-4">
            <div>
                <p class="text-xl font-bold">${match.home.name} vs ${match.away.name}</p>
                <p class="text-sm text-blue-400 font-medium">${d.toLocaleDateString()} @ ${d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
            </div>
            <button onclick="startMatch('${match.id}')" class="bg-emerald-600 hover:bg-emerald-500 text-white px-6 py-2 rounded-full font-bold transition-all">
              Go Live
            </button>
          </div>`;
      });
    }

    async function startMatch(matchId) {
        await supabaseClient.from('matches').update({ status: 'live' }).eq('id', matchId);
        showSection('section-live');
        loadLiveMatches();
        loadUpcomingMatches();
    }

    async function loadLiveMatches() {
      const { data } = await supabaseClient.from('matches').select('*, home:teams!home_team_id(name), away:teams!away_team_id(name)')
        .eq('league_id', eliteLeagueId).eq('status', 'live');

      const container = document.getElementById('liveMatches');
      container.innerHTML = (data.length === 0) ? '<p class="text-gray-500 text-center py-10">No matches are currently live.</p>' : '';

      data.forEach(match => {
        container.innerHTML += `
          <div class="bg-gradient-to-r from-blue-900 to-indigo-900 p-8 rounded-3xl border border-blue-400/30 shadow-2xl relative overflow-hidden mb-6">
            <div class="absolute top-4 right-4 flex items-center gap-2">
                <span class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></span>
                <span class="text-xs font-bold text-red-400 uppercase tracking-widest">Live Now</span>
            </div>
            <div class="flex justify-between items-center text-center">
                <div class="flex-1 text-2xl font-black">${match.home.name}</div>
                <div class="flex-1 text-6xl font-black px-4">${match.home_score} - ${match.away_score}</div>
                <div class="flex-1 text-2xl font-black">${match.away.name}</div>
            </div>
            <button onclick="selectLiveMatch('${match.id}', '${match.home.name}', '${match.away.name}', ${match.home_score}, ${match.away_score})"
                    class="mt-8 block mx-auto bg-white text-blue-900 hover:bg-blue-100 px-10 py-3 rounded-xl font-black transition-transform active:scale-95">
              Open Control Panel
            </button>
          </div>`;
      });
    }

    function selectLiveMatch(id, home, away, hScore, aScore) {
      currentMatchId = id;
      document.getElementById('liveControl').classList.remove('hidden');
      document.getElementById('liveTitle').innerText = `${home} vs ${away}`;
      document.getElementById('currentScore').innerText = `${hScore} - ${aScore}`;
      window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    }

    async function addGoal(team) {
      if (!currentMatchId) return;
      const isHome = team === 'home';
      const { data: match } = await supabaseClient.from('matches').select('home_score, away_score').eq('id', currentMatchId).single();

      const newHome = isHome ? match.home_score + 1 : match.home_score;
      const newAway = isHome ? match.away_score : match.away_score + 1;

      await supabaseClient.from('matches').update({ home_score: newHome, away_score: newAway }).eq('id', currentMatchId);
      await supabaseClient.from('events').insert({
        match_id: currentMatchId, type: 'goal', minute: new Date().getMinutes(),
        team_name: isHome ? document.getElementById('liveTitle').innerText.split(' vs ')[0] : document.getElementById('liveTitle').innerText.split(' vs ')[1]
      });

      document.getElementById('currentScore').innerText = `${newHome} - ${newAway}`;
      loadLiveMatches();
    }

    async function addCard(type) {
      showPrompt("Record Card", `Player name for ${type.toUpperCase()}:`, async (playerName) => {
          if (!playerName) return;
          await supabaseClient.from('events').insert({
            match_id: currentMatchId, type: type === 'yellow' ? 'yellow_card' : 'red_card',
            minute: new Date().getMinutes(), player_name: playerName
          });
          showAlert("Event Recorded", `${type.toUpperCase()} card assigned to ${playerName}.`);
      });
    }

    async function updateMatchStatus(newStatus) {
      const msg = newStatus === 'paused' ? 'Pause match clock?' : 'Confirm Full Time? This cannot be undone.';
      showAlert("Confirm Status Change", msg, async () => {
          await supabaseClient.from('matches').update({ status: newStatus }).eq('id', currentMatchId);
          if (newStatus === 'finished') {
              document.getElementById('liveControl').classList.add('hidden');
              currentMatchId = null;
          }
          loadLiveMatches();
          loadUpcomingMatches();
      });
    }

    window.onload = async function() {
      checkPassword();
      eliteLeagueId = await ensureEliteLeagueExists();
      if (eliteLeagueId) {
        loadTeams();
        loadUpcomingMatches();
        loadLiveMatches();
        setInterval(() => { loadLiveMatches(); loadUpcomingMatches(); }, 5000);
      }
    };
  </script>
</head>

<body class="text-gray-100 min-h-screen flex">

  <div id="customModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
      <div class="absolute inset-0 bg-black/80 backdrop-blur-sm"></div>
      <div class="glass relative w-full max-w-md p-8 rounded-3xl shadow-2xl border border-white/20 text-center">
          <h3 id="modalTitle" class="text-2xl font-black mb-2 text-white">Alert</h3>
          <p id="modalMessage" class="text-gray-400 mb-6">Message content goes here.</p>
          <input id="modalPromptInput" type="text" class="hidden w-full bg-gray-900 border border-gray-700 p-4 rounded-xl mb-6 text-center outline-none focus:border-blue-500 transition-colors" placeholder="Enter value...">
          <button id="modalConfirmBtn" class="bg-blue-600 hover:bg-blue-500 w-full py-4 rounded-xl font-bold uppercase tracking-widest transition-all">Continue</button>
      </div>
  </div>

  <aside class="w-20 md:w-64 glass border-r border-white/5 flex flex-col items-center py-8 gap-8">
      <div class="text-2xl font-black bg-gradient-to-br from-blue-400 to-indigo-600 bg-clip-text text-transparent">ELITE</div>
      <nav class="flex flex-col w-full px-4 gap-2">
          <button onclick="showSection('section-teams')" class="sidebar-link active flex items-center gap-4 p-4 rounded-xl transition-all hover:bg-white/5">
              <span class="text-xl">üõ°Ô∏è</span> <span class="hidden md:block font-semibold">Teams</span>
          </button>
          <button onclick="showSection('section-matches')" class="sidebar-link flex items-center gap-4 p-4 rounded-xl transition-all hover:bg-white/5">
              <span class="text-xl">üìÖ</span> <span class="hidden md:block font-semibold">Fixtures</span>
          </button>
          <button onclick="showSection('section-live')" class="sidebar-link flex items-center gap-4 p-4 rounded-xl transition-all hover:bg-white/5">
              <span class="text-xl">üéÆ</span> <span class="hidden md:block font-semibold">Live Panel</span>
          </button>
      </nav>
  </aside>

  <main class="flex-1 h-screen overflow-y-auto p-4 md:p-12">
    
    <div id="section-teams" class="admin-section max-w-4xl mx-auto">
        <h1 class="text-4xl font-black mb-8">League Teams</h1>
        <div class="glass p-8 rounded-3xl mb-10">
            <h2 class="text-xl font-bold mb-6">Add New Contender</h2>
            <div class="flex flex-col md:flex-row gap-4">
                <input id="teamName" placeholder="Enter Team Name (e.g. CSC 400)" class="bg-gray-900 p-4 rounded-xl flex-1 border border-gray-700 focus:border-blue-500 outline-none" />
                <button onclick="createTeam()" class="bg-blue-600 hover:bg-blue-500 px-10 py-4 rounded-xl font-bold">Add Team</button>
            </div>
        </div>
        <div id="teamsList" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
    </div>

    <div id="section-matches" class="admin-section hidden max-w-4xl mx-auto">
        <h1 class="text-4xl font-black mb-8">Scheduling</h1>
        <div class="glass p-8 rounded-3xl mb-10">
            <h2 class="text-xl font-bold mb-6">Create New Match</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase ml-1">Home Team</label>
                    <select id="homeTeam" class="bg-gray-900 p-4 rounded-xl w-full border border-gray-700 mt-2 outline-none"></select>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase ml-1">Away Team</label>
                    <select id="awayTeam" class="bg-gray-900 p-4 rounded-xl w-full border border-gray-700 mt-2 outline-none"></select>
                </div>
                <div class="md:col-span-2">
                    <label class="text-xs font-bold text-gray-500 uppercase ml-1">Kick-off Date & Time</label>
                    <input type="datetime-local" id="matchDate" class="bg-gray-900 p-4 rounded-xl w-full border border-gray-700 mt-2 outline-none" />
                </div>
                <button onclick="createMatch()" class="md:col-span-2 bg-indigo-600 hover:bg-indigo-500 py-4 rounded-xl font-bold text-lg">Schedule Match</button>
            </div>
        </div>
        <h2 class="text-2xl font-black mb-6">Upcoming Fixtures</h2>
        <div id="upcomingMatches" class="space-y-4"></div>
    </div>

    <div id="section-live" class="admin-section hidden max-w-4xl mx-auto">
        <h1 class="text-4xl font-black mb-8">Live Match Control</h1>
        <div id="liveMatches" class="mb-10"></div>

        <div id="liveControl" class="hidden glass p-10 rounded-[3rem] border-t-4 border-indigo-500 bg-gradient-to-b from-gray-800/50 to-transparent">
            <h3 id="liveTitle" class="text-center text-3xl font-black mb-2 text-blue-300"></h3>
            <div id="currentScore" class="text-center text-8xl font-black mb-12 tracking-tighter">0 - 0</div>

            <div class="grid grid-cols-2 gap-4 mb-8">
                <button onclick="addGoal('home')" class="bg-emerald-600 hover:bg-emerald-500 py-8 rounded-3xl text-2xl font-black shadow-lg shadow-emerald-900/20 active:scale-95 transition-all">Goal Home</button>
                <button onclick="addGoal('away')" class="bg-emerald-600 hover:bg-emerald-500 py-8 rounded-3xl text-2xl font-black shadow-lg shadow-emerald-900/20 active:scale-95 transition-all">Goal Away</button>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-8">
                <button onclick="addCard('yellow')" class="bg-yellow-500 text-black py-4 rounded-2xl font-black flex items-center justify-center gap-2 hover:bg-yellow-400">
                    <span class="w-4 h-6 bg-yellow-300 rounded-sm"></span> Yellow Card
                </button>
                <button onclick="addCard('red')" class="bg-red-600 text-white py-4 rounded-2xl font-black flex items-center justify-center gap-2 hover:bg-red-500">
                    <span class="w-4 h-6 bg-red-400 rounded-sm"></span> Red Card
                </button>
            </div>

            <div class="flex flex-col sm:flex-row gap-4">
                <button onclick="updateMatchStatus('paused')" class="flex-1 bg-gray-700 hover:bg-gray-600 py-4 rounded-2xl font-bold">Pause Match</button>
                <button onclick="updateMatchStatus('finished')" class="flex-1 bg-rose-600 hover:bg-rose-500 py-4 rounded-2xl font-black">End Match (Full Time)</button>
            </div>
        </div>
    </div>

  </main>
</body>
</html>
