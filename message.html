<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UPLINK | Secure Terminal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&display=swap');
        
        body { 
            background-color: #020617; 
            color: #e2e8f0; 
            font-family: 'Space Grotesk', sans-serif;
            overflow: hidden; 
            overscroll-behavior: none;
        }

        .glass { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(12px); }
        .cyber-border { border: 1px solid rgba(59, 130, 246, 0.2); }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #1e3a8a; border-radius: 10px; }

        .drawer-hide { transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .recording-active { color: #ef4444 !important; filter: drop-shadow(0 0 8px #ef4444); }
        
        audio::-webkit-media-controls-panel { background-color: #1e293b; }
        audio::-webkit-media-controls-current-time-display,
        audio::-webkit-media-controls-time-remaining-display { color: #60a5fa; }
    </style>
</head>
<body class="h-screen flex flex-col">

    <div id="username-modal" class="fixed inset-0 z-[100] flex items-center justify-center bg-[#020617]">
        <div class="p-8 w-full max-w-md text-center">
            <h1 class="text-xl font-bold tracking-[0.5em] mb-8 text-blue-500 uppercase">CREATE USERNAME</h1>
            <input type="text" id="username-input" maxlength="12"
                class="w-full bg-transparent border-b border-blue-900 focus:border-blue-500 py-3 text-center text-xl outline-none transition-all text-blue-400 font-mono"
                placeholder="CALLSIGN...">
            <button onclick="establishLink()" class="mt-10 w-full py-4 bg-blue-600 hover:bg-blue-500 text-white font-black tracking-widest uppercase transition-all active:scale-95">
                Establish Link
            </button>
        </div>
    </div>

    <div id="alert-modal" class="hidden fixed inset-0 z-[110] flex items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="bg-slate-900 border border-blue-500/50 p-6 rounded-lg max-w-xs w-full text-center shadow-2xl">
            <p id="alert-text" class="text-blue-400 font-mono text-sm mb-6 uppercase tracking-tighter"></p>
            <button onclick="closeAlert()" class="px-6 py-2 border border-blue-500 text-blue-500 text-xs font-bold uppercase hover:bg-blue-500/10 transition-all">Close</button>
        </div>
    </div>

    <header class="p-4 border-b cyber-border flex items-center justify-between glass">
        <div class="flex items-center gap-3">
            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
            <h2 class="font-bold text-xs tracking-widest uppercase">Uplink // <span id="node-id">000-A</span></h2>
        </div>
        <div id="user-tag" class="text-[10px] font-mono text-blue-400 opacity-70 uppercase"></div>
    </header>

    <main id="chat-display" class="flex-1 overflow-y-auto p-4 space-y-4 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-slate-900 via-slate-950 to-black">
        <div class="text-center py-10 opacity-20 text-[9px] uppercase tracking-[1em]">Secure End-to-End Node</div>
    </main>

    <div id="asset-drawer" class="fixed bottom-[76px] left-0 right-0 glass border-t cyber-border drawer-hide z-40 h-56 overflow-y-auto p-4">
        <div class="max-w-4xl mx-auto">
            <h3 class="text-[10px] uppercase text-slate-500 tracking-widest mb-4">Tactical Stickers</h3>
            <div id="sticker-grid" class="flex flex-wrap gap-4 mb-6">
                <img onclick="sendSticker(this.src)" src="https://cdn-icons-png.flaticon.com/512/3062/3062125.png" class="w-12 h-12 cursor-pointer hover:scale-110">
                <img onclick="sendSticker(this.src)" src="https://cdn-icons-png.flaticon.com/512/3062/3062128.png" class="w-12 h-12 cursor-pointer hover:scale-110">
            </div>
            <h3 class="text-[10px] uppercase text-slate-500 tracking-widest mb-4">Quick Emojis</h3>
            <div class="flex gap-4 text-2xl">
                <span onclick="addEmoji('üî•')" class="cursor-pointer">üî•</span>
                <span onclick="addEmoji('üõ°Ô∏è')" class="cursor-pointer">üõ°Ô∏è</span>
                <span onclick="addEmoji('‚ö†Ô∏è')" class="cursor-pointer">‚ö†Ô∏è</span>
                <span onclick="addEmoji('üíé')" class="cursor-pointer">üíé</span>
                <span onclick="addEmoji('ü§ù')" class="cursor-pointer">ü§ù</span>
            </div>
        </div>
    </div>

    <footer class="p-4 glass border-t cyber-border z-50">
        <div class="max-w-6xl mx-auto flex items-center gap-2">
            <label class="p-3 text-slate-400 hover:text-blue-400 cursor-pointer">
                <i class="fas fa-plus"></i>
                <input type="file" id="image-input" class="hidden" accept="image/*">
            </label>

            <button onclick="toggleDrawer()" class="p-3 text-slate-400 hover:text-blue-400">
                <i class="fas fa-face-smile"></i>
            </button>

            <input type="text" id="msg-input" placeholder="Transmission..." 
                class="flex-1 bg-black/40 border border-slate-800 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-blue-500/50">

            <button id="voice-btn" 
                class="p-3 text-slate-400 transition-all active:scale-125">
                <i class="fas fa-microphone"></i>
            </button>

            <button onclick="sendMessage()" class="bg-blue-600 px-5 py-2 rounded-lg text-white text-xs font-bold uppercase">
                Send
            </button>
        </div>
    </footer>

    <script>
        let userName = "";
        let mediaRecorder;
        let audioChunks = [];
        const chatDisplay = document.getElementById('chat-display');
        const voiceBtn = document.getElementById('voice-btn');

        // --- CORE LOGIC ---
        function showAlert(msg) {
            document.getElementById('alert-text').innerText = msg;
            document.getElementById('alert-modal').classList.remove('hidden');
        }
        function closeAlert() { document.getElementById('alert-modal').classList.add('hidden'); }

        function establishLink() {
            const input = document.getElementById('username-input');
            if(input.value.length < 2) {
                showAlert("Identity Error: Name too short");
                return;
            }
            userName = input.value.toUpperCase();
            document.getElementById('username-modal').classList.add('hidden');
            document.getElementById('user-tag').innerText = `ID: ${userName}`;
            appendMessage("SYSTEM", `Secure tunnel created for ${userName}`, 'system');
        }

        function appendMessage(user, content, type = 'text') {
            const isMe = user === userName;
            const div = document.createElement('div');
            div.className = `flex flex-col ${type === 'system' ? 'items-center' : (isMe ? 'items-end' : 'items-start')} animate-in fade-in slide-in-from-bottom-2 duration-300`;
            
            let contentHtml = "";
            if(type === 'text') {
                contentHtml = `<div class="${isMe ? 'bg-blue-600 text-white' : 'bg-slate-800'} px-4 py-2 rounded-2xl max-w-[80%] text-sm">${content}</div>`;
            } else if(type === 'image') {
                contentHtml = `
                    <div class="relative group">
                        <img src="${content}" class="rounded-xl max-w-[200px] border border-blue-500/20">
                        <button onclick="saveSticker('${content}')" class="absolute top-2 right-2 bg-black/60 p-2 rounded-full opacity-0 group-hover:opacity-100 transition-opacity text-[10px]">
                            <i class="fas fa-bookmark text-blue-400"></i>
                        </button>
                    </div>`;
            } else if(type === 'voice') {
                contentHtml = `<div class="bg-slate-800 p-2 rounded-xl flex flex-col gap-1">
                                <span class="text-[8px] text-blue-400 font-mono">VOICE_TRANSMISSION.RAW</span>
                                <audio controls src="${content}" class="h-8 w-48"></audio>
                               </div>`;
            } else if(type === 'sticker') {
                contentHtml = `<img src="${content}" class="w-24 h-24">`;
            } else if(type === 'system') {
                contentHtml = `<div class="text-[9px] text-blue-500/50 font-mono uppercase tracking-[0.5em] py-4">${content}</div>`;
            }

            div.innerHTML = `${type !== 'system' ? `<span class="text-[9px] text-slate-500 mb-1 px-2 uppercase font-bold">${user}</span>` : ''}${contentHtml}`;
            chatDisplay.appendChild(div);
            chatDisplay.scrollTop = chatDisplay.scrollHeight;
        }

        // --- VOICE RECORDING LOGIC (THE HEART) ---
        async function initVoice() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/mp3' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    appendMessage(userName, audioUrl, 'voice');
                    audioChunks = [];
                };
            } catch (err) {
                showAlert("Mic Access Denied. Voice functions disabled.");
            }
        }

        initVoice(); // Initialize on load

        // Hold to Record Logic (Desktop & Mobile)
        const startRec = (e) => {
            e.preventDefault();
            if(!mediaRecorder || mediaRecorder.state === "recording") return;
            audioChunks = [];
            mediaRecorder.start();
            voiceBtn.classList.add('recording-active');
        };

        const stopRec = () => {
            if(mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop();
                voiceBtn.classList.remove('recording-active');
            }
        };

        voiceBtn.addEventListener('mousedown', startRec);
        voiceBtn.addEventListener('mouseup', stopRec);
        voiceBtn.addEventListener('touchstart', startRec);
        voiceBtn.addEventListener('touchend', stopRec);

        // --- OTHER FEATURES ---
        function sendMessage() {
            const input = document.getElementById('msg-input');
            if(!input.value.trim()) return;
            appendMessage(userName, input.value);
            input.value = "";
            document.getElementById('asset-drawer').classList.add('drawer-hide');
        }

        function toggleDrawer() { document.getElementById('asset-drawer').classList.toggle('drawer-hide'); }
        function addEmoji(emoji) { document.getElementById('msg-input').value += emoji; }
        function sendSticker(src) { appendMessage(userName, src, 'sticker'); toggleDrawer(); }
        
        function saveSticker(src) {
            const grid = document.getElementById('sticker-grid');
            const newSticker = document.createElement('img');
            newSticker.src = src;
            newSticker.className = "w-12 h-12 cursor-pointer hover:scale-110 border border-blue-500/20 rounded";
            newSticker.onclick = () => sendSticker(src);
            grid.appendChild(newSticker);
            showAlert("IMAGE SAVED TO STICKER VAULT");
        }

        document.getElementById('image-input').onchange = (e) => {
            const reader = new FileReader();
            reader.onload = (f) => appendMessage(userName, f.target.result, 'image');
            reader.readAsDataURL(e.target.files[0]);
        };

        document.getElementById('msg-input').onkeypress = (e) => { if(e.key === 'Enter') sendMessage(); };

    </script>
</body>
</html>
