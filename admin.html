<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin - Elite League</title>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.1/dist/tailwind.min.css" rel="stylesheet">

  <script>
    // === REPLACE THESE LATER WHEN YOU CREATE SUPABASE PROJECT ===
    const supabaseUrl = 'https://your-project.supabase.co';      // ← Change later
    const supabaseAnonKey = 'your-anon-key-here';               // ← Change later

    const { createClient } = supabase;
    const supabaseClient = createClient(supabaseUrl, supabaseAnonKey);

    // Password protection - change this!
    const ADMIN_PASSWORD = "elite2026";

    function checkPassword() {
      let pass = prompt("Enter admin password:");
      if (pass !== ADMIN_PASSWORD) {
        alert("Wrong password!");
        window.location.href = "index.html";
      }
    }

    let eliteLeagueId = null;
    let currentMatchId = null;

    // Create Elite League automatically
    async function ensureEliteLeagueExists() {
      let { data, error } = await supabaseClient
        .from('leagues')
        .select('id')
        .eq('name', 'Elite League')
        .single();

      if (error && error.code !== 'PGRST116') {
        console.error(error);
        return null;
      }

      if (data) return data.id;

      const { data: newLeague } = await supabaseClient
        .from('leagues')
        .insert({ name: 'Elite League' })
        .select()
        .single();

      return newLeague.id;
    }

    // Load all teams (for display and dropdowns)
    async function loadTeams() {
      if (!eliteLeagueId) return;

      const { data: teams } = await supabaseClient
        .from('teams')
        .select('*')
        .eq('league_id', eliteLeagueId)
        .order('name');

      // Update dropdowns
      const home = document.getElementById('homeTeam');
      const away = document.getElementById('awayTeam');
      home.innerHTML = away.innerHTML = '<option value="">Select Team</option>';

      teams.forEach(team => {
        const opt = `<option value="${team.id}">${team.name}</option>`;
        home.innerHTML += opt;
        away.innerHTML += opt;
      });

      // Update teams list
      const list = document.getElementById('teamsList');
      if (teams.length === 0) {
        list.innerHTML = '<p class="text-gray-400">No teams added yet.</p>';
      } else {
        list.innerHTML = '';
        teams.forEach(team => {
          list.innerHTML += `
            <div class="bg-gray-700 p-4 rounded-lg">
              <span class="font-bold">${team.name}</span>
            </div>`;
        });
      }
    }

    // Create Team
    async function createTeam() {
      const teamName = document.getElementById('teamName').value.trim();
      if (!teamName) return alert("Enter team name");

      const { error } = await supabaseClient
        .from('teams')
        .insert({ league_id: eliteLeagueId, name: teamName });

      if (error) alert("Error: " + error.message);
      else {
        alert("Team added: " + teamName);
        document.getElementById('teamName').value = '';
        loadTeams();
      }
    }

    // Create Match
    async function createMatch() {
      const homeId = document.getElementById('homeTeam').value;
      const awayId = document.getElementById('awayTeam').value;
      const date = document.getElementById('matchDate').value;

      if (!homeId || !awayId || !date) return alert("Select teams and date");

      const { error } = await supabaseClient.from('matches').insert({
        league_id: eliteLeagueId,
        home_team_id: homeId,
        away_team_id: awayId,
        date: date,
        status: 'scheduled',
        home_score: 0,
        away_score: 0
      });

      if (error) alert("Error: " + error.message);
      else {
        alert("Match created!");
        loadUpcomingMatches();
      }
    }

    // Load Upcoming Matches
    async function loadUpcomingMatches() {
      if (!eliteLeagueId) return;

      const now = new Date().toISOString();

      const { data } = await supabaseClient
        .from('matches')
        .select('*, home:teams!home_team_id(name), away:teams!away_team_id(name)')
        .eq('league_id', eliteLeagueId)
        .in('status', ['scheduled'])
        .gte('date', now)
        .order('date');

      const container = document.getElementById('upcomingMatches');
      if (!data || data.length === 0) {
        container.innerHTML = '<p class="text-gray-400">No upcoming matches.</p>';
        return;
      }

      container.innerHTML = '';
      data.forEach(match => {
        const matchDate = new Date(match.date).toLocaleString();
        container.innerHTML += `
          <div class="bg-gray-700 p-5 rounded-xl mb-4">
            <p class="text-lg font-bold">${match.home.name} vs ${match.away.name}</p>
            <p class="text-sm text-gray-300">${matchDate}</p>
            <button onclick="startMatch('${match.id}')" class="bg-green-600 hover:bg-green-700 px-5 py-2 rounded mt-3 text-sm">
              Start Match (Go Live)
            </button>
          </div>`;
      });
    }

    // Start Match (set status to live)
    async function startMatch(matchId) {
      const confirmStart = confirm("Start this match and make it LIVE?");
      if (!confirmStart) return;

      await supabaseClient
        .from('matches')
        .update({ status: 'live' })
        .eq('id', matchId);

      loadLiveMatches();
      loadUpcomingMatches();
    }

    // Load Live Matches
    async function loadLiveMatches() {
      if (!eliteLeagueId) return;

      const { data } = await supabaseClient
        .from('matches')
        .select('*, home:teams!home_team_id(name), away:teams!away_team_id(name)')
        .eq('league_id', eliteLeagueId)
        .eq('status', 'live');

      const container = document.getElementById('liveMatches');
      if (!data || data.length === 0) {
        container.innerHTML = '<p class="text-gray-400">No live matches.</p>';
        return;
      }

      container.innerHTML = '';
      data.forEach(match => {
        container.innerHTML += `
          <div class="p-6 bg-gradient-to-br from-purple-900 to-blue-900 rounded-xl mb-6">
            <p class="text-2xl font-bold text-center">${match.home.name} vs ${match.away.name}</p>
            <p class="text-5xl font-bold text-center my-4">${match.home_score} - ${match.away_score}</p>
            <button onclick="selectLiveMatch('${match.id}', '${match.home.name}', '${match.away.name}', ${match.home_score}, ${match.away_score})"
                    class="block mx-auto bg-yellow-600 hover:bg-yellow-700 px-8 py-3 rounded-lg font-bold">
              Control This Match
            </button>
          </div>`;
      });
    }

    // Select match for control
    function selectLiveMatch(id, home, away, hScore, aScore) {
      currentMatchId = id;
      document.getElementById('liveControl').classList.remove('hidden');
      document.getElementById('liveTitle').innerText = `${home} vs ${away}`;
      document.getElementById('currentScore').innerText = `${hScore} - ${aScore}`;
    }

    // Goal
    async function addGoal(team) {
      if (!currentMatchId) return;
      const isHome = team === 'home';
      const { data: match } = await supabaseClient.from('matches').select('home_score, away_score').eq('id', currentMatchId).single();

      const newHome = isHome ? match.home_score + 1 : match.home_score;
      const newAway = isHome ? match.away_score : match.away_score + 1;

      await supabaseClient.from('matches').update({ home_score: newHome, away_score: newAway }).eq('id', currentMatchId);
      await supabaseClient.from('events').insert({
        match_id: currentMatchId,
        type: 'goal',
        minute: new Date().getMinutes(),
        team_name: isHome ? document.getElementById('liveTitle').innerText.split(' vs ')[0] : document.getElementById('liveTitle').innerText.split(' vs ')[1]
      });

      document.getElementById('currentScore').innerText = `${newHome} - ${newAway}`;
    }

    // Yellow / Red Card
    async function addCard(type) {
      if (!currentMatchId) return;
      const playerName = prompt(`Enter player name for ${type === 'yellow' ? 'Yellow' : 'Red'} card:`);
      if (!playerName) return;

      await supabaseClient.from('events').insert({
        match_id: currentMatchId,
        type: type === 'yellow' ? 'yellow_card' : 'red_card',
        minute: new Date().getMinutes(),
        player_name: playerName
      });

      alert(`${type === 'yellow' ? 'Yellow' : 'Red'} card added to ${playerName}`);
    }

    // Pause / End Match
    async function updateMatchStatus(newStatus) {
      if (!currentMatchId) return;
      const confirmMsg = newStatus === 'paused' ? 'Pause the match?' : 'End the match (Full Time)?';
      if (!confirm(confirmMsg)) return;

      await supabaseClient.from('matches').update({ status: newStatus }).eq('id', currentMatchId);

      if (newStatus === 'finished') {
        document.getElementById('liveControl').classList.add('hidden');
        currentMatchId = null;
      }

      loadLiveMatches();
      loadUpcomingMatches();
    }

    // Public Live Scores (for testing or embedding in index.html)
    async function loadPublicLiveScores() {
      const { data } = await supabaseClient
        .from('matches')
        .select('*, home:teams!home_team_id(name), away:teams!away_team_id(name)')
        .eq('league_id', eliteLeagueId)
        .in('status', ['live', 'finished'])
        .order('date', { ascending: false });

      const zone = document.getElementById('publicLiveScores');
      if (!zone) return;

      if (!data || data.length === 0) {
        zone.innerHTML = '<p class="text-center text-gray-400 text-xl">No active or recent matches</p>';
        return;
      }

      zone.innerHTML = '<h2 class="text-4xl font-bold text-center mb-8">Live & Recent Scores</h2>';
      data.forEach(match => {
        const statusBadge = match.status === 'live'
          ? '<span class="bg-red-600 text-white px-4 py-1 rounded-full text-sm animate-pulse">LIVE</span>'
          : '<span class="bg-gray-600 text-white px-4 py-1 rounded-full text-sm">Full Time</span>';

        zone.innerHTML += `
          <div class="bg-gray-800 p-10 rounded-3xl text-center mb-8 shadow-2xl">
            <div class="flex justify-center items-center gap-4 mb-4">
              <span class="text-2xl font-bold">${match.home.name}</span>
              <span class="text-gray-500">vs</span>
              <span class="text-2xl font-bold">${match.away.name}</span>
            </div>
            <p class="text-7xl font-black my-6">${match.home_score} - ${match.away_score}</p>
            <div>${statusBadge}</div>
          </div>`;
      });
    }

    // Start everything
    window.onload = async function() {
      checkPassword();
      eliteLeagueId = await ensureEliteLeagueExists();
      if (eliteLeagueId) {
        loadTeams();
        loadUpcomingMatches();
        loadLiveMatches();
        loadPublicLiveScores();

        // Auto refresh every 5 seconds
        setInterval(() => {
          loadLiveMatches();
          loadUpcomingMatches();
          loadPublicLiveScores();
        }, 5000);
      }
    };
  </script>
</head>

<body class="bg-gray-900 text-white min-h-screen p-6">
  <div class="max-w-5xl mx-auto">
    <h1 class="text-5xl font-black text-center mb-12">Elite League Admin Control</h1>

    <!-- ALL TEAMS LIST -->
    <div class="bg-gray-800 p-8 rounded-2xl mb-10">
      <h2 class="text-3xl font-bold mb-6">All Teams</h2>
      <div id="teamsList" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
        <!-- Teams will appear here -->
      </div>
    </div>

    <!-- ADD TEAM -->
    <div class="bg-gray-800 p-8 rounded-2xl mb-10">
      <h2 class="text-3xl font-bold mb-6">Add New Team</h2>
      <div class="flex gap-4 items-end">
        <input id="teamName" placeholder="e.g. CSC 300" class="bg-gray-700 p-4 rounded-lg flex-1" />
        <button onclick="createTeam()" class="bg-blue-600 hover:bg-blue-700 px-8 py-4 rounded-lg font-bold">
          Add Team
        </button>
      </div>
    </div>

    <!-- CREATE MATCH -->
    <div class="bg-gray-800 p-8 rounded-2xl mb-10">
      <h2 class="text-3xl font-bold mb-6">Create New Match</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label class="block mb-2">Home Team</label>
          <select id="homeTeam" class="bg-gray-700 p-4 rounded-lg w-full"></select>
        </div>
        <div>
          <label class="block mb-2">Away Team</label>
          <select id="awayTeam" class="bg-gray-700 p-4 rounded-lg w-full"></select>
        </div>
        <div class="md:col-span-2">
          <label class="block mb-2">Date & Time</label>
          <input type="datetime-local" id="matchDate" class="bg-gray-700 p-4 rounded-lg w-full" />
        </div>
        <div class="md:col-span-2">
          <button onclick="createMatch()" class="bg-green-600 hover:bg-green-700 px-10 py-4 rounded-lg font-bold w-full">
            Create Match
          </button>
        </div>
      </div>
    </div>

    <!-- UPCOMING MATCHES -->
    <div class="bg-gray-800 p-8 rounded-2xl mb-10">
      <h2 class="text-3xl font-bold mb-6">Upcoming Matches</h2>
      <div id="upcomingMatches" class="space-y-4"></div>
    </div>

    <!-- LIVE MATCHES -->
    <div class="bg-gray-800 p-8 rounded-2xl mb-10">
      <h2 class="text-3xl font-bold mb-6">Live Matches</h2>
      <div id="liveMatches" class="space-y-4"></div>
    </div>

    <!-- LIVE CONTROL PANEL -->
    <div id="liveControl" class="hidden bg-gradient-to-br from-purple-900 to-pink-900 p-10 rounded-3xl mb-10">
      <h3 id="liveTitle" class="text-4xl font-black text-center mb-8"></h3>
      <p class="text-6xl font-black text-center mb-10">Score: <span id="currentScore">0 - 0</span></p>

      <div class="grid grid-cols-2 gap-6 mb-8">
        <button onclick="addGoal('home')" class="bg-green-600 hover:bg-green-700 py-6 rounded-2xl text-2xl font-black">
          Goal Home
        </button>
        <button onclick="addGoal('away')" class="bg-green-600 hover:bg-green-700 py-6 rounded-2xl text-2xl font-black">
          Goal Away
        </button>
      </div>

      <div class="grid grid-cols-2 gap-6 mb-8">
        <button onclick="addCard('yellow')" class="bg-yellow-600 hover:bg-yellow-700 py-5 rounded-2xl text-xl font-black">
          Yellow Card
        </button>
        <button onclick="addCard('red')" class="bg-red-600 hover:bg-red-700 py-5 rounded-2xl text-xl font-black">
          Red Card
        </button>
      </div>

      <div class="flex justify-center gap-6">
        <button onclick="updateMatchStatus('paused')" class="bg-orange-600 hover:bg-orange-700 px-10 py-5 rounded-2xl text-xl font-black">
          Pause Match
        </button>
        <button onclick="updateMatchStatus('finished')" class="bg-gray-600 hover:bg-gray-700 px-10 py-5 rounded-2xl text-xl font-black">
          End Match (Full Time)
        </button>
      </div>
    </div>

    <!-- PUBLIC LIVE SCORES (You can copy this section to your index.html) -->
    <div class="bg-gray-800 p-10 rounded-3xl">
      <h2 class="text-4xl font-bold text-center mb-10">Public Live Scores Preview</h2>
      <div id="publicLiveScores" class="space-y-6"></div>
    </div>
  </div>
</body>
</html>
